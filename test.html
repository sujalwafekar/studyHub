<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - StudyHub</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            min-height: 80vh;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .question-text {
            font-size: 1.15rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 18px;
            line-height: 1.5;
        }

        .options-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-item {
            padding: 14px 16px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.85);
        }

        .option-item:hover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
            transform: translateX(4px);
        }

        .option-input {
            margin-right: 12px;
            accent-color: #667eea;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .score-display {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin-bottom: 24px;
            font-size: 1.8rem;
            font-weight: 700;
            display: none;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .correct-answer {
            background: rgba(67, 227, 123, 0.2) !important;
            border-color: #43e97b !important;
            color: #43e97b !important;
        }

        .wrong-answer {
            background: rgba(245, 87, 108, 0.2) !important;
            border-color: #f5576c !important;
            color: #f5576c !important;
        }

        .option-item span {
            flex: 1;
            font-size: 1rem;
            line-height: 1.5;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .difficulty-easy {
            background: rgba(67, 227, 123, 0.2);
            color: #43e97b;
            border: 1px solid #43e97b;
        }

        .difficulty-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .difficulty-hard {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
            border: 1px solid #f5576c;
        }
    </style>
</head>

<body>
    <!-- Animated background -->
    <div class="bg-animation">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <div class="test-container">
        <a href="index.html" class="btn back-btn">‚Üê Back to Dashboard</a>

        <div id="loading" class="glass-card" style="text-align: center; padding: 40px;">
            <h2>Loading Test...</h2>
        </div>

        <div id="test-content" style="display: none;">
            <div class="glass-card mb-4" style="padding: 20px; margin-bottom: 30px;">
                <h1 id="test-title">Quiz</h1>
                <p id="test-subtitle" style="opacity: 0.8;">Answer the following questions generated from your study
                    material.</p>
            </div>

            <div id="score-card" class="score-display"></div>

            <form id="quiz-form">
                <div id="questions-list"></div>

                <button type="submit" class="btn btn-primary btn-large" style="width: 100%; margin-top: 20px;">
                    Submit Test
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="config.js"></script>

    <script>
        // Initialize Firebase
        if (typeof firebaseConfig !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
        } else {
            console.error('firebaseConfig not found. Make sure config.js is loaded.');
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Get resource ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const resourceId = urlParams.get('resourceId');

        let currentQuestions = [];

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                loadTest(resourceId);
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadTest(id) {
            if (!id) {
                alert('No test specified');
                window.location.href = 'index.html';
                return;
            }

            db.collection('resources').doc(id).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Resource not found');
                        return;
                    }

                    const data = doc.data();
                    const questions = data.questions;

                    if (!questions || questions.length === 0) {
                        alert('No questions generated for this file. Try uploading a new file.');
                        window.location.href = 'index.html';
                        return;
                    }

                    currentQuestions = questions;
                    renderQuestions(questions, data.title);
                })
                .catch(error => {
                    console.error('Error loading test:', error);
                    alert('Error loading test');
                });
        }

        function renderQuestions(questions, title) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('test-content').style.display = 'block';
            document.getElementById('test-title').textContent = 'Quiz: ' + title;

            const container = document.getElementById('questions-list');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';

                // Add difficulty badge
                if (q.difficulty) {
                    const difficultyBadge = document.createElement('span');
                    difficultyBadge.className = 'difficulty-badge difficulty-' + q.difficulty.toLowerCase();
                    difficultyBadge.textContent = q.difficulty;
                    card.appendChild(difficultyBadge);
                }

                const questionTitle = document.createElement('div');
                questionTitle.className = 'question-text';
                questionTitle.textContent = `${index + 1}. ${q.question}`;

                const optionsList = document.createElement('div');
                optionsList.className = 'options-list';

                q.options.forEach(opt => {
                    const label = document.createElement('label');
                    label.className = 'option-item';

                    // Extract Option letter (A, B, C, D)
                    const letter = opt.charAt(0); // Assumes "A) Option" format

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `q${index}`;
                    radio.value = letter; // Value is 'A', 'B', etc.
                    radio.className = 'option-input';
                    radio.required = true;

                    const text = document.createElement('span');
                    text.textContent = opt;

                    label.appendChild(radio);
                    label.appendChild(text);
                    optionsList.appendChild(label);
                });

                card.appendChild(questionTitle);
                card.appendChild(optionsList);
                container.appendChild(card);
            });
        }

        document.getElementById('quiz-form').addEventListener('submit', function (e) {
            e.preventDefault();

            let score = 0;
            const formData = new FormData(this);
            const questionCards = document.querySelectorAll('.question-card');

            currentQuestions.forEach((q, index) => {
                const selected = formData.get(`q${index}`);
                const correct = q.correctAnswer;
                const card = questionCards[index];

                // Highlight logic
                const inputs = card.querySelectorAll('input');
                inputs.forEach(input => {
                    input.disabled = true; // Disable after submit
                    const label = input.parentElement;

                    // Visual feedback
                    if (input.value === correct) {
                        label.classList.add('correct-answer');
                    } else if (input.checked && input.value !== correct) {
                        label.classList.add('wrong-answer');
                    }
                });

                if (selected === correct) {
                    score++;
                }
            });

            // Show score
            const scoreCard = document.getElementById('score-card');
            scoreCard.style.display = 'block';
            scoreCard.textContent = `You scored ${score} out of ${currentQuestions.length}`;

            // Hide submit button
            this.querySelector('button[type="submit"]').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>

</html>